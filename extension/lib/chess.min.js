var Chess=(()=>{var pe=Object.defineProperty;var is=Object.getOwnPropertyDescriptor;var rs=Object.getOwnPropertyNames;var ns=Object.prototype.hasOwnProperty;var os=(f,t)=>{for(var e in t)pe(f,e,{get:t[e],enumerable:!0})},as=(f,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of rs(t))!ns.call(f,r)&&r!==e&&pe(f,r,{get:()=>t[r],enumerable:!(s=is(t,r))||s.enumerable});return f};var ls=f=>as(pe({},"__esModule",{value:!0}),f);var Is={};os(Is,{BISHOP:()=>Z,BLACK:()=>K,Chess:()=>Se,DEFAULT_POSITION:()=>ne,KING:()=>P,KNIGHT:()=>oe,Move:()=>j,PAWN:()=>T,QUEEN:()=>F,ROOK:()=>W,SEVEN_TAG_ROSTER:()=>ae,SQUARES:()=>vs,WHITE:()=>O,validateFen:()=>et,xoroshiro128:()=>Je});function fs(f){return f!==null?{comment:f,variations:[]}:{variations:[]}}function hs(f,t,e,s,r){let n={move:f,variations:r};return t&&(n.suffix=t),e&&(n.nag=e),s!==null&&(n.comment=s),n}function cs(...f){let[t,...e]=f,s=t;for(let r of e)r!==null&&(s.variations=[r,...r.variations],r.variations=[],s=r);return t}function us(f,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){let s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:f,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function _s(f,t){function e(){this.constructor=f}e.prototype=t.prototype,f.prototype=new e}function V(f,t,e,s){var r=Error.call(this,f);return Object.setPrototypeOf&&Object.setPrototypeOf(r,V.prototype),r.expected=t,r.found=e,r.location=s,r.name="SyntaxError",r}_s(V,Error);function ge(f,t,e){return e=e||" ",f.length>t?f:(t-=f.length,e+=e.repeat(t),f+e.slice(0,t))}V.prototype.format=function(f){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<f.length;s++)if(f[s].source===this.location.source){e=f[s].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,n=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,c=this.location.source+":"+n.line+":"+n.column;if(e){var h=this.location.end,u=ge("",n.line.toString().length," "),g=e[r.line-1],d=r.line===h.line?h.column:g.length+1,A=d-r.column||1;t+=`
 --> `+c+`
`+u+` |
`+n.line+" | "+g+`
`+u+" | "+ge("",r.column-1," ")+ge("",A,"^")}else t+=`
 at `+c}return t};V.buildMessage=function(f,t){var e={literal:function(g){return'"'+r(g.text)+'"'},class:function(g){var d=g.parts.map(function(A){return Array.isArray(A)?n(A[0])+"-"+n(A[1]):n(A)});return"["+(g.inverted?"^":"")+d.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function s(g){return g.charCodeAt(0).toString(16).toUpperCase()}function r(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function n(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function c(g){return e[g.type](g)}function h(g){var d=g.map(c),A,p;if(d.sort(),d.length>0){for(A=1,p=1;A<d.length;A++)d[A-1]!==d[A]&&(d[p]=d[A],p++);d.length=p}switch(d.length){case 1:return d[0];case 2:return d[0]+" or "+d[1];default:return d.slice(0,-1).join(", ")+", or "+d[d.length-1]}}function u(g){return g?'"'+r(g)+'"':"end of input"}return"Expected "+h(f)+" but "+u(t)+" found."};function ps(f,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,r={pgn:Be},n=Be,c="[",h='"',u="]",g=".",d="O-O-O",A="O-O",p="0-0-0",E="0-0",$="$",y="{",q="}",fe=";",he="(",tt=")",Ce="1-0",Ae="0-1",$e="1/2-1/2",st="*",ce=/^[a-zA-Z]/,ke=/^[^"]/,X=/^[0-9]/,ye=/^[.]/,Te=/^[a-zA-Z1-8\-=]/,it=/^[+#]/,Pe=/^[!?]/,Ne=/^[^}]/,we=/^[^\r\n]/,Ie=/^[ \t\r\n]/,rt=M("tag pair"),nt=N("[",!1),Oe=N('"',!1),ot=N("]",!1),at=M("tag name"),ue=R([["a","z"],["A","Z"]],!1,!1),lt=M("tag value"),xe=R(['"'],!0,!1),ft=M("move number"),ee=R([["0","9"]],!1,!1),ht=N(".",!1),Ke=R(["."],!1,!1),ct=M("standard algebraic notation"),ut=N("O-O-O",!1),_t=N("O-O",!1),pt=N("0-0-0",!1),gt=N("0-0",!1),Me=R([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),dt=R(["+","#"],!1,!1),mt=M("suffix annotation"),Le=R(["!","?"],!1,!1),vt=M("NAG"),bt=N("$",!1),Et=M("brace comment"),St=N("{",!1),Re=R(["}"],!0,!1),Ct=N("}",!1),At=M("rest of line comment"),$t=N(";",!1),qe=R(["\r",`
`],!0,!1),kt=M("variation"),yt=N("(",!1),Tt=N(")",!1),Pt=M("game termination marker"),Nt=N("1-0",!1),wt=N("0-1",!1),It=N("1/2-1/2",!1),Ot=N("*",!1),xt=M("whitespace"),Fe=R([" ","	","\r",`
`],!1,!1),Kt=function(i,a){return us(i,a)},Mt=function(i){return Object.fromEntries(i)},Lt=function(i,a){return[i,a]},Rt=function(i,a){return{root:i,marker:a}},qt=function(i,a){return cs(fs(i),...a.flat())},Ft=function(i,a,l,v,b){return hs(i,a,l,v,b)},Dt=function(i){return i},Ut=function(i){return i.replace(/[\r\n]+/g," ")},Bt=function(i){return i.trim()},Qt=function(i){return i},jt=function(i,a){return{result:i,comment:a}},o=t.peg$currPos|0,G=[{line:1,column:1}],L=o,te=t.peg$maxFailExpected||[],_=t.peg$silentFails|0,Y;if(t.startRule){if(!(t.startRule in r))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=r[t.startRule]}function N(i,a){return{type:"literal",text:i,ignoreCase:a}}function R(i,a,l){return{type:"class",parts:i,inverted:a,ignoreCase:l}}function Ht(){return{type:"end"}}function M(i){return{type:"other",description:i}}function De(i){var a=G[i],l;if(a)return a;if(i>=G.length)l=G.length-1;else for(l=i;!G[--l];);for(a=G[l],a={line:a.line,column:a.column};l<i;)f.charCodeAt(l)===10?(a.line++,a.column=1):a.column++,l++;return G[i]=a,a}function Ue(i,a,l){var v=De(i),b=De(a),k={source:s,start:{offset:i,line:v.line,column:v.column},end:{offset:a,line:b.line,column:b.column}};return k}function m(i){o<L||(o>L&&(L=o,te=[]),te.push(i))}function Gt(i,a,l){return new V(V.buildMessage(i,a),i,a,l)}function Be(){var i,a,l;return i=o,a=Wt(),l=zt(),i=Kt(a,l),i}function Wt(){var i,a,l;for(i=o,a=[],l=Qe();l!==e;)a.push(l),l=Qe();return l=x(),i=Mt(a),i}function Qe(){var i,a,l,v,b,k,B;return _++,i=o,x(),f.charCodeAt(o)===91?(a=c,o++):(a=e,_===0&&m(nt)),a!==e?(x(),l=Vt(),l!==e?(x(),f.charCodeAt(o)===34?(v=h,o++):(v=e,_===0&&m(Oe)),v!==e?(b=Yt(),f.charCodeAt(o)===34?(k=h,o++):(k=e,_===0&&m(Oe)),k!==e?(x(),f.charCodeAt(o)===93?(B=u,o++):(B=e,_===0&&m(ot)),B!==e?i=Lt(l,b):(o=i,i=e)):(o=i,i=e)):(o=i,i=e)):(o=i,i=e)):(o=i,i=e),_--,i===e&&_===0&&m(rt),i}function Vt(){var i,a,l;if(_++,i=o,a=[],l=f.charAt(o),ce.test(l)?o++:(l=e,_===0&&m(ue)),l!==e)for(;l!==e;)a.push(l),l=f.charAt(o),ce.test(l)?o++:(l=e,_===0&&m(ue));else a=e;return a!==e?i=f.substring(i,o):i=a,_--,i===e&&(a=e,_===0&&m(at)),i}function Yt(){var i,a,l;for(_++,i=o,a=[],l=f.charAt(o),ke.test(l)?o++:(l=e,_===0&&m(xe));l!==e;)a.push(l),l=f.charAt(o),ke.test(l)?o++:(l=e,_===0&&m(xe));return i=f.substring(i,o),_--,a=e,_===0&&m(lt),i}function zt(){var i,a,l;return i=o,a=je(),x(),l=ss(),l===e&&(l=null),x(),i=Rt(a,l),i}function je(){var i,a,l,v;for(i=o,a=_e(),a===e&&(a=null),l=[],v=He();v!==e;)l.push(v),v=He();return i=qt(a,l),i}function He(){var i,a,l,v,b,k,B,se;if(i=o,x(),Zt(),x(),a=Jt(),a!==e){for(l=Xt(),l===e&&(l=null),v=[],b=Ge();b!==e;)v.push(b),b=Ge();for(b=x(),k=_e(),k===e&&(k=null),B=[],se=We();se!==e;)B.push(se),se=We();i=Ft(a,l,v,k,B)}else o=i,i=e;return i}function Zt(){var i,a,l,v,b,k;for(_++,i=o,a=[],l=f.charAt(o),X.test(l)?o++:(l=e,_===0&&m(ee));l!==e;)a.push(l),l=f.charAt(o),X.test(l)?o++:(l=e,_===0&&m(ee));if(f.charCodeAt(o)===46?(l=g,o++):(l=e,_===0&&m(ht)),l!==e){for(v=x(),b=[],k=f.charAt(o),ye.test(k)?o++:(k=e,_===0&&m(Ke));k!==e;)b.push(k),k=f.charAt(o),ye.test(k)?o++:(k=e,_===0&&m(Ke));a=[a,l,v,b],i=a}else o=i,i=e;return _--,i===e&&(a=e,_===0&&m(ft)),i}function Jt(){var i,a,l,v,b,k;if(_++,i=o,a=o,f.substr(o,5)===d?(l=d,o+=5):(l=e,_===0&&m(ut)),l===e&&(f.substr(o,3)===A?(l=A,o+=3):(l=e,_===0&&m(_t)),l===e&&(f.substr(o,5)===p?(l=p,o+=5):(l=e,_===0&&m(pt)),l===e&&(f.substr(o,3)===E?(l=E,o+=3):(l=e,_===0&&m(gt)),l===e))))if(l=o,v=f.charAt(o),ce.test(v)?o++:(v=e,_===0&&m(ue)),v!==e){if(b=[],k=f.charAt(o),Te.test(k)?o++:(k=e,_===0&&m(Me)),k!==e)for(;k!==e;)b.push(k),k=f.charAt(o),Te.test(k)?o++:(k=e,_===0&&m(Me));else b=e;b!==e?(v=[v,b],l=v):(o=l,l=e)}else o=l,l=e;return l!==e?(v=f.charAt(o),it.test(v)?o++:(v=e,_===0&&m(dt)),v===e&&(v=null),l=[l,v],a=l):(o=a,a=e),a!==e?i=f.substring(i,o):i=a,_--,i===e&&(a=e,_===0&&m(ct)),i}function Xt(){var i,a,l;for(_++,i=o,a=[],l=f.charAt(o),Pe.test(l)?o++:(l=e,_===0&&m(Le));l!==e;)a.push(l),a.length>=2?l=e:(l=f.charAt(o),Pe.test(l)?o++:(l=e,_===0&&m(Le)));return a.length<1?(o=i,i=e):i=a,_--,i===e&&(a=e,_===0&&m(mt)),i}function Ge(){var i,a,l,v,b;if(_++,i=o,x(),f.charCodeAt(o)===36?(a=$,o++):(a=e,_===0&&m(bt)),a!==e){if(l=o,v=[],b=f.charAt(o),X.test(b)?o++:(b=e,_===0&&m(ee)),b!==e)for(;b!==e;)v.push(b),b=f.charAt(o),X.test(b)?o++:(b=e,_===0&&m(ee));else v=e;v!==e?l=f.substring(l,o):l=v,l!==e?i=Dt(l):(o=i,i=e)}else o=i,i=e;return _--,i===e&&_===0&&m(vt),i}function _e(){var i;return i=es(),i===e&&(i=ts()),i}function es(){var i,a,l,v,b;if(_++,i=o,f.charCodeAt(o)===123?(a=y,o++):(a=e,_===0&&m(St)),a!==e){for(l=o,v=[],b=f.charAt(o),Ne.test(b)?o++:(b=e,_===0&&m(Re));b!==e;)v.push(b),b=f.charAt(o),Ne.test(b)?o++:(b=e,_===0&&m(Re));l=f.substring(l,o),f.charCodeAt(o)===125?(v=q,o++):(v=e,_===0&&m(Ct)),v!==e?i=Ut(l):(o=i,i=e)}else o=i,i=e;return _--,i===e&&(a=e,_===0&&m(Et)),i}function ts(){var i,a,l,v,b;if(_++,i=o,f.charCodeAt(o)===59?(a=fe,o++):(a=e,_===0&&m($t)),a!==e){for(l=o,v=[],b=f.charAt(o),we.test(b)?o++:(b=e,_===0&&m(qe));b!==e;)v.push(b),b=f.charAt(o),we.test(b)?o++:(b=e,_===0&&m(qe));l=f.substring(l,o),i=Bt(l)}else o=i,i=e;return _--,i===e&&(a=e,_===0&&m(At)),i}function We(){var i,a,l,v;return _++,i=o,x(),f.charCodeAt(o)===40?(a=he,o++):(a=e,_===0&&m(yt)),a!==e?(l=je(),l!==e?(x(),f.charCodeAt(o)===41?(v=tt,o++):(v=e,_===0&&m(Tt)),v!==e?i=Qt(l):(o=i,i=e)):(o=i,i=e)):(o=i,i=e),_--,i===e&&_===0&&m(kt),i}function ss(){var i,a,l;return _++,i=o,f.substr(o,3)===Ce?(a=Ce,o+=3):(a=e,_===0&&m(Nt)),a===e&&(f.substr(o,3)===Ae?(a=Ae,o+=3):(a=e,_===0&&m(wt)),a===e&&(f.substr(o,7)===$e?(a=$e,o+=7):(a=e,_===0&&m(It)),a===e&&(f.charCodeAt(o)===42?(a=st,o++):(a=e,_===0&&m(Ot))))),a!==e?(x(),l=_e(),l===e&&(l=null),i=jt(a,l)):(o=i,i=e),_--,i===e&&(a=e,_===0&&m(Pt)),i}function x(){var i,a;for(_++,i=[],a=f.charAt(o),Ie.test(a)?o++:(a=e,_===0&&m(Fe));a!==e;)i.push(a),a=f.charAt(o),Ie.test(a)?o++:(a=e,_===0&&m(Fe));return _--,a=e,_===0&&m(xt),i}if(Y=n(),t.peg$library)return{peg$result:Y,peg$currPos:o,peg$FAILED:e,peg$maxFailExpected:te,peg$maxFailPos:L};if(Y!==e&&o===f.length)return Y;throw Y!==e&&o<f.length&&m(Ht()),Gt(te,L<f.length?f.charAt(L):null,L<f.length?Ue(L,L+1):Ue(L,L))}var re=0xffffffffffffffffn;function de(f,t){return(f<<t|f>>64n-t)&0xffffffffffffffffn}function Ve(f,t){return f*t&re}function Je(f){return function(){let t=BigInt(f&re),e=BigInt(f>>64n&re),s=Ve(de(Ve(t,5n),7n),9n);return e^=t,t=(de(t,24n)^e^e<<16n)&re,e=de(e,37n),f=e<<64n|t,s}}var le=Je(0xa187eb39cdcaed8f31c4b365b102e01en),gs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>le()))),ds=Array.from({length:8},()=>le()),ms=Array.from({length:16},()=>le()),me=le(),O="w",K="b",T="p",oe="n",Z="b",W="r",F="q",P="k",ne="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",j=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){let{color:s,piece:r,from:n,to:c,flags:h,captured:u,promotion:g}=e,d=w(n),A=w(c);this.color=s,this.piece=r,this.from=d,this.to=A,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=d+A,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(let p in C)C[p]&h&&(this.flags+=Q[p]);u&&(this.captured=u),g&&(this.promotion=g,this.lan+=g)}isCapture(){return this.flags.indexOf(Q.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(Q.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(Q.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(Q.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(Q.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(Q.BIG_PAWN)>-1}},I=-1,Q={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},vs=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},ae={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},bs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Es={...ae,...bs},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ve={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ye={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ss=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Cs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],As={p:1,n:2,b:4,r:8,q:16,k:32},$s="pnbrqkPNBRQK",ze=[oe,Z,W,F],ks=7,ys=6,Ts=1,Ps=0,ie={[P]:C.KSIDE_CASTLE,[F]:C.QSIDE_CASTLE},D={w:[{square:S.a1,flag:C.QSIDE_CASTLE},{square:S.h1,flag:C.KSIDE_CASTLE}],b:[{square:S.a8,flag:C.QSIDE_CASTLE},{square:S.h8,flag:C.KSIDE_CASTLE}]},Ns={b:Ts,w:ys},be="--";function H(f){return f>>4}function J(f){return f&15}function Xe(f){return"0123456789".indexOf(f)!==-1}function w(f){let t=J(f),e=H(f);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function z(f){return f===O?K:O}function et(f){let t=f.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let r=t[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let c=0;c<r.length;c++){let h=0,u=!1;for(let g=0;g<r[c].length;g++)if(Xe(r[c][g])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};h+=parseInt(r[c][g],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[c][g]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};h+=1,u=!1}if(h!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:c,regex:h}of n){if(!h.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${c} king`};if((t[0].match(h)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${c} kings`}}return Array.from(r[0]+r[7]).some(c=>c.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function ws(f,t){let e=f.from,s=f.to,r=f.piece,n=0,c=0,h=0;for(let u=0,g=t.length;u<g;u++){let d=t[u].from,A=t[u].to,p=t[u].piece;r===p&&e!==d&&s===A&&(n++,H(e)===H(d)&&c++,J(e)===J(d)&&h++)}return n>0?c>0&&h>0?w(e):h>0?w(e).charAt(1):w(e).charAt(0):""}function U(f,t,e,s,r,n=void 0,c=C.NORMAL){let h=H(s);if(r===T&&(h===ks||h===Ps))for(let u=0;u<ze.length;u++){let g=ze[u];f.push({color:t,from:e,to:s,piece:r,captured:n,promotion:g,flags:c|C.PROMOTION})}else f.push({color:t,from:e,to:s,piece:r,captured:n,flags:c})}function Ze(f){let t=f.charAt(0);return t>="a"&&t<="h"?f.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?P:t)}function Ee(f){return f.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var Se=class{_board=new Array(128);_turn=O;_header={};_kings={w:I,b:I};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=ne,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:I,b:I},this._turn=O,this._castling={w:0,b:0},this._epSquare=I,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Es},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let r=t.split(/\s+/);if(r.length>=2&&r.length<6){let h=["-","-","0","1"];t=r.concat(h.slice(-(6-r.length))).join(" ")}if(r=t.split(/\s+/),!e){let{ok:h,error:u}=et(t);if(!h)throw new Error(u)}let n=r[0],c=0;this.clear({preserveHeaders:s});for(let h=0;h<n.length;h++){let u=n.charAt(h);if(u==="/")c+=8;else if(Xe(u))c+=parseInt(u,10);else{let g=u<"a"?O:K;this._put({type:u.toLowerCase(),color:g},w(c)),c++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=r[3]==="-"?I:S[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let c=S.a8;c<=S.h1;c++){if(this._board[c]){e>0&&(s+=e,e=0);let{color:h,type:u}=this._board[c];s+=h===O?u.toUpperCase():u.toLowerCase()}else e++;c+1&136&&(e>0&&(s+=e),c!==S.h1&&(s+="/"),e=0,c+=8)}let r="";this._castling[O]&C.KSIDE_CASTLE&&(r+="K"),this._castling[O]&C.QSIDE_CASTLE&&(r+="Q"),this._castling[K]&C.KSIDE_CASTLE&&(r+="k"),this._castling[K]&C.QSIDE_CASTLE&&(r+="q"),r=r||"-";let n="-";if(this._epSquare!==I)if(t)n=w(this._epSquare);else{let c=this._epSquare+(this._turn===O?16:-16),h=[c+1,c-1];for(let u of h){if(u&136)continue;let g=this._turn;if(this._board[u]?.color===g&&this._board[u]?.type===T){this._makeMove({color:g,from:u,to:this._epSquare,piece:T,captured:T,flags:C.EP_CAPTURE});let d=!this._isKingAttacked(g);if(this._undoMove(),d){n=w(this._epSquare);break}}}}return[s,this._turn,r,n,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:e,type:s}=this._board[t],r={w:0,b:1}[e],n={p:0,n:1,b:2,r:3,q:4,k:5}[s];return gs[r][n][t]}_epKey(){return this._epSquare===I?0n:ds[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return ms[t]}_computeHash(){let t=0n;for(let e=S.a8;e<=S.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=me),t}_updateSetup(t){this._history.length>0||(t!==ne?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ne)}get(t){return this._board[S[t]]}findPiece(t){let e=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(w(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if($s.indexOf(t.toLowerCase())===-1||!(s in S))return!1;let r=S[s];if(t==P&&!(this._kings[e]==I||this._kings[e]==r))return!1;let n=this._board[r];return n&&n.type===P&&(this._kings[n.color]=I),this._set(r,{type:t,color:e}),t===P&&(this._kings[e]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let e=this.get(t);return this._clear(S[t]),e&&e.type===P&&(this._kings[e.color]=I),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[S.e1]?.type===P&&this._board[S.e1]?.color===O,e=this._board[S.e8]?.type===P&&this._board[S.e8]?.color===K;(!t||this._board[S.a1]?.type!==W||this._board[S.a1]?.color!==O)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==W||this._board[S.h1]?.color!==O)&&(this._castling.w&=-33),(!e||this._board[S.a8]?.type!==W||this._board[S.a8]?.color!==K)&&(this._castling.b&=-65),(!e||this._board[S.h8]?.type!==W||this._board[S.h8]?.color!==K)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===I)return;let t=this._epSquare+(this._turn===O?-16:16),e=this._epSquare+(this._turn===O?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==z(this._turn)||this._board[e]?.type!==T){this._hash^=this._epKey(),this._epSquare=I;return}let r=n=>!(n&136)&&this._board[n]?.color===this._turn&&this._board[n]?.type===T;s.some(r)||(this._hash^=this._epKey(),this._epSquare=I)}_attacked(t,e,s){let r=[];for(let n=S.a8;n<=S.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==t)continue;let c=this._board[n],h=n-e;if(h===0)continue;let u=h+119;if(Ss[u]&As[c.type]){if(c.type===T){if(h>0&&c.color===O||h<=0&&c.color===K)if(s)r.push(w(n));else return!0;continue}if(c.type==="n"||c.type==="k")if(s){r.push(w(n));continue}else return!0;let g=Cs[u],d=n+g,A=!1;for(;d!==e;){if(this._board[d]!=null){A=!0;break}d+=g}if(!A)if(s){r.push(w(n));continue}else return!0}}return s?r:!1}attackers(t,e){return e?this._attacked(e,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){let e=this._kings[t];return e===-1?!1:this._attacked(z(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},e=[],s=0,r=0;for(let n=S.a8;n<=S.h1;n++){if(r=(r+1)%2,n&136){n+=7;continue}let c=this._board[n];c&&(t[c.type]=c.type in t?t[c.type]+1:1,c.type===Z&&e.push(r),s++)}if(s===2)return!0;if(s===3&&(t[Z]===1||t[oe]===1))return!0;if(s===t[Z]+2){let n=0,c=e.length;for(let h=0;h<c;h++)n+=e[h];if(n===0||n===c)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){let r=this._moves({square:e,piece:s});return t?r.map(n=>new j(this,n)):r.map(n=>this._moveToSan(n,r))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){let r=s?s.toLowerCase():void 0,n=e?.toLowerCase(),c=[],h=this._turn,u=z(h),g=S.a8,d=S.h1,A=!1;if(r)if(r in S)g=d=S[r],A=!0;else return[];for(let E=g;E<=d;E++){if(E&136){E+=7;continue}if(!this._board[E]||this._board[E].color===u)continue;let{type:$}=this._board[E],y;if($===T){if(n&&n!==$)continue;y=E+ve[h][0],this._board[y]||(U(c,h,E,y,T),y=E+ve[h][1],Ns[h]===H(E)&&!this._board[y]&&U(c,h,E,y,T,void 0,C.BIG_PAWN));for(let q=2;q<4;q++)y=E+ve[h][q],!(y&136)&&(this._board[y]?.color===u?U(c,h,E,y,T,this._board[y].type,C.CAPTURE):y===this._epSquare&&U(c,h,E,y,T,T,C.EP_CAPTURE))}else{if(n&&n!==$)continue;for(let q=0,fe=Ye[$].length;q<fe;q++){let he=Ye[$][q];for(y=E;y+=he,!(y&136);){if(!this._board[y])U(c,h,E,y,$);else{if(this._board[y].color===h)break;U(c,h,E,y,$,this._board[y].type,C.CAPTURE);break}if($===oe||$===P)break}}}}if((n===void 0||n===P)&&(!A||d===this._kings[h])){if(this._castling[h]&C.KSIDE_CASTLE){let E=this._kings[h],$=E+2;!this._board[E+1]&&!this._board[$]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,E+1)&&!this._attacked(u,$)&&U(c,h,this._kings[h],$,P,void 0,C.KSIDE_CASTLE)}if(this._castling[h]&C.QSIDE_CASTLE){let E=this._kings[h],$=E-2;!this._board[E-1]&&!this._board[E-2]&&!this._board[E-3]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,E-1)&&!this._attacked(u,$)&&U(c,h,this._kings[h],$,P,void 0,C.QSIDE_CASTLE)}}if(!t||this._kings[h]===-1)return c;let p=[];for(let E=0,$=c.length;E<$;E++)this._makeMove(c[E]),this._isKingAttacked(h)||p.push(c[E]),this._undoMove();return p}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(be,e);else if(typeof t=="object"){let n=this._moves();for(let c=0,h=n.length;c<h;c++)if(t.from===w(n[c].from)&&t.to===w(n[c].to)&&(!("promotion"in n[c])||t.promotion===n[c].promotion)){s=n[c];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");let r=new j(this,s);return this._makeMove(s),this._incPositionCount(),r}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){let e=this._turn,s=z(e);if(this._push(t),t.flags&C.NULL_MOVE){e===K&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=I;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&C.EP_CAPTURE&&(this._turn===K?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===P){if(this._kings[e]=t.to,t.flags&C.KSIDE_CASTLE){let r=t.to-1,n=t.to+1;this._movePiece(n,r)}else if(t.flags&C.QSIDE_CASTLE){let r=t.to+1,n=t.to-2;this._movePiece(n,r)}this._castling[e]=0}if(this._castling[e]){for(let r=0,n=D[e].length;r<n;r++)if(t.from===D[e][r].square&&this._castling[e]&D[e][r].flag){this._castling[e]^=D[e][r].flag;break}}if(this._castling[s]){for(let r=0,n=D[s].length;r<n;r++)if(t.to===D[s][r].square&&this._castling[s]&D[s][r].flag){this._castling[s]^=D[s][r].flag;break}}if(this._hash^=this._castlingKey(),t.flags&C.BIG_PAWN){let r;e===K?r=t.to-16:r=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===T&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===T&&this._board[t.to+1]?.color===s?(this._epSquare=r,this._hash^=this._epKey()):this._epSquare=I}else this._epSquare=I;t.piece===T?this._halfMoves=0:t.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===K&&this._moveNumber++,this._turn=s,this._hash^=me}undo(){let t=this._hash,e=this._undoMove();if(e){let s=new j(this,e);return this._decPositionCount(t),s}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=me;let s=this._turn,r=z(s);if(e.flags&C.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&C.EP_CAPTURE){let n;s===K?n=e.to-16:n=e.to+16,this._set(n,{type:T,color:r})}else this._set(e.to,{type:e.captured,color:r});if(e.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let n,c;e.flags&C.KSIDE_CASTLE?(n=e.to+1,c=e.to-1):(n=e.to-2,c=e.to+1),this._movePiece(c,n)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){let s=[],r=!1;for(let p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+t),r=!0;r&&this._history.length&&s.push(t);let n=p=>{let E=this._comments[this.fen()];if(typeof E<"u"){let $=p.length>0?" ":"";p=`${p}${$}{${E}}`}return p},c=[];for(;this._history.length>0;)c.push(this._undoMove());let h=[],u="";for(c.length===0&&h.push(n(""));c.length>0;){u=n(u);let p=c.pop();if(!p)break;if(!this._history.length&&p.color==="b"){let E=`${this._moveNumber}. ...`;u=u?`${u} ${E}`:E}else p.color==="w"&&(u.length&&h.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(u.length&&h.push(n(u)),h.push(this._header.Result||"*"),e===0)return s.join("")+h.join(" ");let g=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},d=function(p,E){for(let $ of E.split(" "))if($){if(p+$.length>e){for(;g();)p--;s.push(t),p=0}s.push($),p+=$.length,s.push(" "),p++}return g()&&p--,p},A=0;for(let p=0;p<h.length;p++){if(A+h[p].length>e&&h[p].includes("{")){A=d(A,h[p]);continue}A+h[p].length>e&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),A=0):p!==0&&(s.push(" "),A++),s.push(h[p]),A+=h[p].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??ae[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=ae[t]||null,!0):!1}getHeaders(){let t={};for(let[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));let r=ps(t);this.reset();let n=r.headers,c="";for(let g in n)g.toLowerCase()==="fen"&&(c=n[g]),this.header(g,n[g]);if(!e)c&&this.load(c,{preserveHeaders:!0});else if(n.SetUp==="1"){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}let h=r.root;for(;h;){if(h.move){let g=this._moveFromSan(h.move,e);if(g==null)throw new Error(`Invalid move in PGN: ${h.move}`);this._makeMove(g),this._incPositionCount()}h.comment!==void 0&&(this._comments[this.fen()]=h.comment),h=h.variations[0]}let u=r.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&C.KSIDE_CASTLE)s="O-O";else if(t.flags&C.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&C.NULL_MOVE)return be;if(t.piece!==T){let r=ws(t,e);s+=t.piece.toUpperCase()+r}t.flags&(C.CAPTURE|C.EP_CAPTURE)&&(t.piece===T&&(s+=w(t.from)[0]),s+="x"),s+=w(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ee(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==be)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let r=Ze(s),n=this._moves({legal:!0,piece:r});for(let p=0,E=n.length;p<E;p++)if(s===Ee(this._moveToSan(n[p],n)))return n[p];if(e)return null;let c,h,u,g,d,A=!1;if(h=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),h?(c=h[1],u=h[2],g=h[3],d=h[4],u.length==1&&(A=!0)):(h=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),h&&(c=h[1],u=h[2],g=h[3],d=h[4],u.length==1&&(A=!0))),r=Ze(s),n=this._moves({legal:!0,piece:c||r}),!g)return null;for(let p=0,E=n.length;p<E;p++)if(u){if((!c||c.toLowerCase()==n[p].piece)&&S[u]==n[p].from&&S[g]==n[p].to&&(!d||d.toLowerCase()==n[p].promotion))return n[p];if(A){let $=w(n[p].from);if((!c||c.toLowerCase()==n[p].piece)&&S[g]==n[p].to&&(u==$[0]||u==$[1])&&(!d||d.toLowerCase()==n[p].promotion))return n[p]}}else if(s===Ee(this._moveToSan(n[p],n)).replace("x",""))return n[p];return null}ascii(){let t=`   +------------------------+
`;for(let e=S.a8;e<=S.h1;e++){if(J(e)===0&&(t+=" "+"87654321"[H(e)]+" |"),this._board[e]){let s=this._board[e].type,n=this._board[e].color===O?s.toUpperCase():s.toLowerCase();t+=" "+n+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let e=this._moves({legal:!1}),s=0,r=this._turn;for(let n=0,c=e.length;n<c;n++)this._makeMove(e[n]),this._isKingAttacked(r)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],e=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?e.push(null):e.push({square:w(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in S){let e=S[t];return(H(e)+J(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){let r=e.pop();if(!r)break;t?s.push(new j(this,r)):s.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){let t=[],e={},s=r=>{r in this._comments&&(e[r]=this._comments[r])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){let r=t.pop();if(!r)break;this._makeMove(r),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(let r of[P,F])e[r]!==void 0&&(e[r]?this._castling[t]|=ie[r]:this._castling[t]&=~ie[r]);this._updateCastlingRights();let s=this.getCastlingRights(t);return(e[P]===void 0||e[P]===s[P])&&(e[F]===void 0||e[F]===s[F])}getCastlingRights(t){return{[P]:(this._castling[t]&ie[P])!==0,[F]:(this._castling[t]&ie[F])!==0}}moveNumber(){return this._moveNumber}};return ls(Is);})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
